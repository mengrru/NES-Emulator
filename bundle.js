var app=function(){"use strict";function t(){}function e(t){return t()}function s(){return Object.create(null)}function r(t){t.forEach(e)}function n(t){return"function"==typeof t}function i(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function a(t,e){t.appendChild(e)}function o(t){t.parentNode.removeChild(t)}function c(t){return document.createElement(t)}function u(){return t=" ",document.createTextNode(t);var t}function l(t,e,s,r){return t.addEventListener(e,s,r),()=>t.removeEventListener(e,s,r)}function d(t,e,s){null==s?t.removeAttribute(e):t.getAttribute(e)!==s&&t.setAttribute(e,s)}function h(t,e,s){t.classList[s?"add":"remove"](e)}let R;function A(t){R=t}const f=[],g=[],p=[],P=[],S=Promise.resolve();let C=!1;function m(t){p.push(t)}const I=new Set;let M=0;function v(){const t=R;do{for(;M<f.length;){const t=f[M];M++,A(t),b(t.$$)}for(A(null),f.length=0,M=0;g.length;)g.pop()();for(let t=0;t<p.length;t+=1){const e=p[t];I.has(e)||(I.add(e),e())}p.length=0}while(f.length);for(;P.length;)P.pop()();C=!1,I.clear(),A(t)}function b(t){if(null!==t.fragment){t.update(),r(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(m)}}const w=new Set;function O(t,e){-1===t.$$.dirty[0]&&(f.push(t),C||(C=!0,S.then(v)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function X(i,a,c,u,l,d,h,f=[-1]){const g=R;A(i);const p=i.$$={fragment:null,ctx:null,props:d,update:t,not_equal:l,bound:s(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(a.context||(g?g.$$.context:[])),callbacks:s(),dirty:f,skip_bound:!1,root:a.target||g.$$.root};h&&h(p.root);let P=!1;if(p.ctx=c?c(i,a.props||{},((t,e,...s)=>{const r=s.length?s[0]:e;return p.ctx&&l(p.ctx[t],p.ctx[t]=r)&&(!p.skip_bound&&p.bound[t]&&p.bound[t](r),P&&O(i,t)),e})):[],p.update(),P=!0,r(p.before_update),p.fragment=!!u&&u(p.ctx),a.target){if(a.hydrate){const t=function(t){return Array.from(t.childNodes)}(a.target);p.fragment&&p.fragment.l(t),t.forEach(o)}else p.fragment&&p.fragment.c();a.intro&&((S=i.$$.fragment)&&S.i&&(w.delete(S),S.i(C))),function(t,s,i,a){const{fragment:o,on_mount:c,on_destroy:u,after_update:l}=t.$$;o&&o.m(s,i),a||m((()=>{const s=c.map(e).filter(n);u?u.push(...s):r(s),t.$$.on_mount=[]})),l.forEach(m)}(i,a.target,a.anchor,a.customElement),v()}var S,C;A(g)}const y=[78,69,83,26];var D;!function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.FOUR_SCREEN=2]="FOUR_SCREEN"}(D||(D={}));const L={ADDR_SPACE:{CPU_RAM_START:0,CPU_RAM_END:8191,PPU_REG_START:8192,PPU_REG_END:16383,PRG_ROM_START:32768,PRG_ROM_END:65535},IR:{RESET:65532}},k=8192,E=8193,T=8194,_=8195,Y=8196,B=8197,N=8198,Z=8199,$=16404;class x{constructor(){this.value=Array(8).fill(0)}set(t){this.value=t.toString(2).split("").reverse().map((t=>parseInt(t)))}get(){return parseInt(this.value.reverse().map((t=>t.toString())).join(""),2)}updateBit(t,e){this.value[t]=e}}class H{constructor(){this.value=0}set(t){this.value=t}get(){return this.value}inc(t=1){let e=this.value+t;this.value=255&e}}class V{constructor(){this.value=[0,0],this.sethi=!0}set(t){this.value[0]=t>>8,this.value[1]=255&t}get(){return this.value[0]<<8|this.value[1]}updateByte(t){this.sethi?this.value[0]=t:this.value[1]=t,this.sethi=!this.sethi}inc(t){let e=this.value[1]+t;this.value[1]=255&e,e>this.value[1]&&(this.value[0]=this.value[0]+1&255)}reset(){this.sethi=!0}}class j extends x{constructor(t){super(),this.ppu=t}get nametable(){switch(this.value[1]<<1|this.value[0]){case 0:return 8192;case 1:return 9216;case 2:return 10240;case 3:return 11264}}get vramAddrInc(){return this.value[2]?32:1}set vramAddrInc(t){this.value[2]=32===t?1:0}get spriteAddr(){return this.value[3]?4096:0}set spriteAddr(t){this.value[3]=4096===t?1:0}get backgroundAddr(){return this.value[4]?4096:0}set backgroundAddr(t){this.value[4]=4096===t?1:0}get spriteSize(){return this.value[5]?128:64}set spriteSize(t){this.value[5]=128===t?1:0}get ppuSelect(){return this.value[6]}set ppuSelect(t){this.value[6]=t}get hasNMI(){return!!this.value[7]}set hasNMI(t){const e=this.value[7];this.value[7]=+t,!e&&t&&this.ppu.regStatus.inVblank&&this.ppu.IR_NMI()}}class W extends x{constructor(){super()}get greyscale(){return!!this.value[0]}get showBgInLeftmost(){return!!this.value[1]}get showSpritesInLeftmost(){return!!this.value[2]}get showBg(){return!!this.value[3]}get showSprites(){return!!this.value[4]}get emRed(){return!!this.value[5]}get emGreen(){return!!this.value[6]}get emBlue(){return!!this.value[7]}}class U extends x{constructor(){super()}get spriteOverflow(){return!!this.value[5]}set spriteOverflow(t){this.value[5]=+t}get sprite0Hit(){return!!this.value[6]}set sprite0Hit(t){this.value[6]=+t}get inVblank(){return!!this.value[7]}set inVblank(t){this.value[7]=+t}}class G extends H{constructor(){super()}}class K extends H{constructor(){super()}}class F extends V{constructor(){super()}get x(){return this.value[0]}get y(){return this.value[1]}}class J extends V{constructor(){super()}}class q extends H{constructor(){super()}}class z extends H{constructor(){super()}}var Q=["#6d6d6d","#002491","#0000da","#6d48da","#91006d","#b6006d","#b62400","#914800","#6d4800","#244800","#006d24","#009100","#004848","#000000","#000000","#000000","#b6b6b6","#006dda","#0048ff","#9100ff","#b600ff","#ff0091","#ff0000","#da6d00","#916d00","#249100","#009100","#00b66d","#009191","#000000","#000000","#000000","#ffffff","#6db6ff","#9191ff","#da6dff","#ff00ff","#ff6dff","#ff9100","#ffb600","#dada00","#6dda00","#00ff00","#48ffda","#00ffff","#000000","#000000","#000000","#ffffff","#b6daff","#dab6ff","#ffb6ff","#ff91ff","#ffb6b6","#ffda91","#ffff48","#ffff6d","#b6ff48","#91ff6d","#48ffda","#91daff","#000000","#000000","#000000"].map((function(t){return t=t.slice(1),[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4),16)]}));const tt=[0,261],et=261;class st{constructor(t){this.t=Array.from(Array(262)).map((t=>Array.from(Array(341)).map((t=>[])))),this.ppu=t,this.init()}exec(t,e){this.t[t][e].forEach((t=>t()))}init(){this.setAction(tt,340,(()=>{this.ppu.isSprite0Hit&&(this.ppu.regStatus.sprite0Hit=!0)})),this.setAction(240,0,(()=>{this.ppu.frame()})),this.setAction(241,340,(()=>{this.ppu.regStatus.inVblank=!0,this.ppu.regStatus.sprite0Hit=!1,this.ppu.regController.hasNMI&&this.ppu.IR_NMI()})),this.setAction(261,1,(()=>{this.ppu.regStatus.inVblank=!1,this.ppu.regStatus.sprite0Hit=!1})),this.setAction(tt,256,(()=>{this.ppu.renderingEnable&&this.ppu.v++})),this.setAction(tt,257,(()=>{this.ppu.renderingEnable&&(this.ppu.v&=31712,this.ppu.v|=1055&this.ppu.t)})),this.setAction(et,[280,304],(()=>{this.ppu.renderingEnable&&(this.ppu.v&=1055,this.ppu.v|=31712&this.ppu.t)})),this.setAction(tt,[328,340],(()=>{})),this.setAction(tt,[0,256],(()=>{}))}setAction(t,e,s){if("number"==typeof t&&"number"==typeof e)this.t[t][e].push(s);else if(Array.isArray(t)&&Array.isArray(e))for(let r=t[0];r<=t[1];r++)for(let t=e[0];t<=e[1];t++)this.t[r][t].push(s);else if(Array.isArray(t))for(let r=t[0];r<=t[1];r++)this.t[r][e].push(s);else if(Array.isArray(e))for(let r=e[0];r<=e[1];r++)this.t[t][r].push(s)}}const{CHR_ROM_START:rt,CHR_ROM_END:nt,VRAM_START:it,VRAM_END:at,PALETTES_START:ot,PALETTES_END:ct}={CHR_ROM_START:0,CHR_ROM_END:8191,VRAM_START:8192,VRAM_END:16127,PALETTES_START:16128,PALETTES_END:16383};class ut{constructor(t){this.paletteTable=Array(32).fill(0),this.VRAM=Array(2048).fill(0),this.OAMData=Array(256).fill(0),this._clockCycle=0,this.scanline=0,this.internalBuf=0,this.v=0,this.t=0,this.x=0,this.w=0,this.regController=new j(this),this.regMask=new W,this.regStatus=new U,this.regOAMAddress=new G,this.regOAMData=new K,this.regScroll=new F,this.regAddress=new J,this.regData=new q,this.regOAMDMA=new z,this.timing=new st(this),this.VRAMMap=function(){const t=3840,e=Array(t);for(let s=0;s<t;s++){let t,r,n;if(s<960){const e=s;n=e+32*Math.floor(e/32),t=s%32,r=Math.floor(s/32)}else if(s>=1024&&s<1984){const e=s-1024;n=e+32*(Math.floor(e/32)+1),t=e%32,r=Math.floor(e/32)}else if(s>=2048&&s<3008){const e=s-128;n=e+32*Math.floor((e-2048)/32),t=(s-2048)%32,r=Math.floor((s-2048)/32)}else if(s>=3072&&s<4032){const e=s-1024-128;n=e+32*(Math.floor((e-2048)/32)+1),t=(s-3072)%32,r=Math.floor((s-3072)/32)}e[n]={data:0,attrIndex:Rt(t,r),paletteIndexPosi:At(t,r)}}return e}(),this.CHRROM=t.rom.CHRROM,this.mirroring=t.rom.screenMirroring,this.bus=t}get clockCycle(){return this._clockCycle}set clockCycle(t){if(t>this._clockCycle){const e=this._clockCycle;for(let s=0;s<t-e;s++)this._clockCycle++,this.tick()}else this._clockCycle=t}get write(){const t=this;return{[k](e,s=-1){-1===s?t.regController.set(e):t.regController.updateBit(s,e),t.t&=29695,t.t|=(3&e)<<10},[E](e,s=-1){t.regMask.set(e)},[_](e){t.regOAMAddress.set(e),t.regOAMData.set(t.OAMRead(e))},[Y](e){t.regOAMData.set(e),t.OAMWrite(t.regOAMAddress.get(),e),t.regOAMAddress.inc()},[B](e){t.regScroll.updateByte(e),0===t.w?(t.t&=32736,t.t|=(248&e)>>3,t.x=7&e,t.w=1):(t.t&=3103,t.t|=(192&e)<<2,t.t|=(56&e)<<2,t.t|=(7&e)<<12,t.w=0)},[N](e){t.regAddress.updateByte(e),0===t.w?(t.t&=255,t.t|=(63&e)<<8,t.w=1):(t.t&=32512,t.t|=e,t.v=t.t,t.w=0)},[Z](e){t.regData.set(e),t.memWrite(t.regAddress.get(),e),t.regAddress.inc(t.regController.vramAddrInc)},OAM_DMA(e,s){t.regOAMDMA.set(e),0!==s.length&&t.writePagetoOAM(s)}}}get read(){const t=this;return{[E]:()=>t.regMask.get(),[B]:()=>(t.regScroll.reset(),t.regScroll.get()),[k]:()=>t.regController.get(),[_]:()=>t.regOAMAddress.get(),[N]:()=>t.regAddress.value[1],[T]:()=>(t.w=0,t.regScroll.reset(),t.regAddress.reset(),t.regStatus.get()),[Y]:()=>t.OAMRead(t.regOAMAddress.get()),[Z](){const e=t.regAddress.get(),s=t.memRead(e);return t.regData.set(s),t.regData.get()}}}tick(){341===this._clockCycle&&(this._clockCycle=0,this.scanline++,262===this.scanline&&(this.scanline=0)),this.timing.exec(this.scanline,this._clockCycle)}get isSprite0Hit(){const t=this.OAMData[3],e=this.OAMData[0];return this.scanline===e&&t<=this._clockCycle&&this.regMask.showSprites}get renderingEnable(){return this.regMask.showBg||this.regMask.showSprites}IR_NMI(){this.bus.cpu.IR_NMI()}writePagetoOAM(t){this.OAMData=t}OAMRead(t){return this.OAMData[t]}OAMWrite(t,e){this.OAMData[t]=e}VRAMRead(t){const e=ft(t-it,this.mirroring);return this.VRAM[e]}VRAMWrite(t,e){const s=ft(t-it,this.mirroring);this.VRAM[s]=e;const r=t-it;if(r<960){const t=r;this.VRAMMap[t+32*Math.floor(t/32)].data=e}else if(r>=1024&&r<1984){const t=r-1024;this.VRAMMap[t+32*(Math.floor(t/32)+1)].data=e}else if(r>=2048&&r<3008){const t=r-128;this.VRAMMap[t+32*Math.floor((t-2048)/32)].data=e}else if(r>=3072&&r<4032){const t=r-1024-128;this.VRAMMap[t+32*(Math.floor((t-2048)/32)+1)].data=e}}memRead(t){t%=16384;const e=this.internalBuf;switch(!0){case t>=rt&&t<=nt:return this.internalBuf=this.CHRROM[t],e;case t>=it&&t<=at:return this.internalBuf=this.VRAMRead(t),e;case t>=ot&&t<=ct:return this.paletteTable[t-ot];default:console.warn("invalid PPU memRead."+t.toString(16))}}memWrite(t,e){switch((t%=16384)<8192&&(t+=8192),!0){case t>=it&&t<=at:return this.VRAMWrite(t,e);case t>=ot&&t<=ct:return void(this.paletteTable[t-ot]=e);default:console.warn("invalid PPU memWrite."+t.toString(16))}}frame(){this.renderBackground(),this.renderSprites(),this.bus.screen.render()}renderBackground(){const t=this.regController.nametable,e=this.regController.backgroundAddr,s=ft(t-it,this.mirroring),r=this.VRAM.slice(s,s+1024).slice(-64),n=this.bus.screen.scale;for(let s=t,i=0;s<t+960;s++,i++){const t=16*(this.VRAMRead(s)||0)+e,a=ht(i%32,Math.floor(i/32),r),o=gt(this.CHRROM.slice(t,t+8),this.CHRROM.slice(t+8,t+16),lt(this.paletteTable,a));this.bus.screen.drawATile(o,i%32*n*8,Math.floor(i/32)*n*8)}}renderSprites(){const t=this.OAMData,e=this.bus.screen.scale;for(let s=t.length-4;s>=0;s-=4){const r=t[s+3],n=t[s],i=t[s+1],a=t[s+2];if(a>>5&1)continue;const o=!!(a>>6&1),c=!!(a>>7&1),u=dt(this.paletteTable,3&a),l=this.regController.spriteAddr+16*i,d=gt(this.CHRROM.slice(l,l+8),this.CHRROM.slice(l+8,l+16),u,c,o,!0);this.bus.screen.drawATile(d,r*e,n*e)}}tiles_test(){const t=this.CHRROM.length,e=[];for(let s=0;s<t;s+=16)e.push(gt(this.CHRROM.slice(s,s+8),this.CHRROM.slice(s+8,s+16)));return e}}function lt(t,e){return t.slice(4*e,4*e+4)}function dt(t,e){return t.slice(16+4*e,16+4*e+4)}function ht(t,e,s){const r=s[Math.floor(t/4)+8*Math.floor(e/4)];switch((Math.floor(t%4/2)<<1)+Math.floor(e%4/2)){case 0:return 3&r;case 2:return r>>2&3;case 1:return r>>4&3;case 3:return r>>6&3}}function Rt(t,e){return Math.floor(t/4)+8*Math.floor(e/4)}function At(t,e){switch((Math.floor(t%4/2)<<1)+Math.floor(e%4/2)){case 0:return 0;case 2:return 1;case 1:return 2;case 3:return 3}}function ft(t,e){return e===D.VERTICAL?t%2048:e===D.HORIZONTAL?1===Math.floor(t/1024)||2===Math.floor(t/1024)?t-1024:3===Math.floor(t/1024)?t-2048:t:void console.warn(`VRAM addr: ${t}`)}function gt(t,e,s,r=!1,n=!1,i=!1){s||(s=[35,39,48]);const a=[];for(let o=0;o<8;o++)for(let c=0;c<8;c++){const u=r?7-o:o,l=n?7-c:c;void 0===a[u]&&(a[u]=[]);const d=pt(e[o],c)<<1|pt(t[o],c);a[u][l]=i&&0===d?[0,0,0,0]:Q[s[d]]}return a}function pt(t,e){return t>>e&1}var Pt;!function(t){t[t.A=1]="A",t[t.B=2]="B",t[t.Select=4]="Select",t[t.Start=8]="Start",t[t.Up=16]="Up",t[t.Down=32]="Down",t[t.Left=64]="Left",t[t.Right=128]="Right"}(Pt||(Pt={}));class St{constructor(){this.strobe=!1,this.btn=Pt.A,this.curReportedBtn=0}write(t){this.strobe=1==(1&t),this.strobe&&(this.curReportedBtn=0)}read(){if(this.curReportedBtn>7)return 1;const t=(this.btn&1<<this.curReportedBtn)>>this.curReportedBtn;return!this.strobe&&this.curReportedBtn<=7&&(this.curReportedBtn+=1),t}setBtn(t){this.btn=t}initUI(){document.onkeydown=t=>{switch(t.code.toLowerCase()){case"keya":this.setBtn(Pt.Left);break;case"keyd":this.setBtn(Pt.Right);break;case"keys":this.setBtn(Pt.Down);break;case"keyw":this.setBtn(Pt.Up);break;case"keyj":this.setBtn(Pt.A);break;case"keyk":this.setBtn(Pt.B);break;case"enter":this.setBtn(Pt.Select);break;case"space":this.setBtn(Pt.Start)}}}}const{CPU_RAM_START:Ct,CPU_RAM_END:mt,PRG_ROM_START:It,PRG_ROM_END:Mt,PPU_REG_START:vt,PPU_REG_END:bt}=L.ADDR_SPACE;function wt(t){switch(!0){case t>=Ct&&t<=mt:return 2047&t;case t>=vt&&t<=bt:return 8199&t;default:return t}}function Ot(t){switch(!0){case t<=255:return 255;case t<=mt:return 2047;case t<=bt:return 8199;case t>=It:return Mt;default:return console.warn("不在范围内的地址"+t),32767}}class Xt{constructor(){}static screen(t){const e=document.createElement("span");e.innerText=t+"\n",document.getElementsByTagName("body")[0].appendChild(e)}static console(t){console.log(t)}}function yt(t){return(128&t)>0?t-256:t}function Dt(t){return 65535&t}function Lt(t,e){return(65280&t)!=(65280&e)?1:0}function kt(t){return t.toString(16)}const Et={I:function(t,e){return{addr:-1,data:e,isCrossPage:0}},Z:function(t,e){return{addr:e,data:t.memRead(e),isCrossPage:0}},ZX:function(t,e){const s=e+t.Register.X&255;return{addr:s,data:t.memRead(s),isCrossPage:0}},ZY:function(t,e){const s=e+t.Register.Y&255;return{addr:s,data:t.memRead(s),isCrossPage:0}},A:function(t,e){return{addr:e,data:t.memRead(e),isCrossPage:0}},AX:function(t,e){const s=e+t.Register.X&65535;return{addr:s,data:t.memRead(s),isCrossPage:Lt(e,s)}},AY:function(t,e){const s=e+t.Register.Y&65535;return{addr:s,data:t.memRead(s),isCrossPage:Lt(e,s)}},IN:function(t,e,s){let r=t.memRead(e,2);if("JMP"===s){const s=65280&e,n=255==(255&e)?s:e+1;r=t.memRead(e)|t.memRead(n)<<8}return{addr:r,data:t.memRead(r),isCrossPage:0}},IX:function(t,e){const s=t.memRead(e+t.Register.X&255,2);return{addr:s,data:t.memRead(s),isCrossPage:0}},IY:function(t,e){const s=t.memRead(e,2),r=s+t.Register.Y&65535;return{addr:r,data:t.memRead(r),isCrossPage:Lt(s,r)}},IM:function(t,e){return{addr:-1,data:-1,isCrossPage:0}},R:function(t,e){return{addr:-1,data:e,isCrossPage:0}},AC:function(t,e){return{addr:-1,data:t.Register.A,isCrossPage:0}}},Tt=function(t,e){t.C=e?1:0},_t=function(t,e){t.Z=0===e?1:0},Yt=function(t,e){t.I=e},Bt=function(t,e){const s=function(t){switch(t){case"PHP":case"BRK":return 1;case"IRQ":case"NMI":case"PLP":return 0}return 0}(e);t.B=2|s},Nt=function(t,e){t.N=(128&e)>>7};const Zt={ADC:function(t,e,s){const{data:r}=s,n=t.Register.A,i=r,a=n+i+t.PS.C;return t.Register.A=255&a,_t(t.PS,t.Register.A),Tt(t.PS,a>255),Nt(t.PS,t.Register.A),t.PS.V=n<128&&i<128?t.Register.A<128?0:1:n>=128&&i>=128&&t.Register.A<128?1:0,"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},SBC:function(t,e,s){return Zt.ADC(t,e,Object.assign(Object.assign({},s),{data:255&~s.data})),"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},AND:function(t,e,s){const{data:r}=s,n=t.Register.A&r;return t.Register.A=n,_t(t.PS,t.Register.A),Nt(t.PS,t.Register.A),"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},ASL:function(t,e,s){const{data:r,addr:n}=s,i=r<<1;return"AC"==e?t.Register.A=255&i:t.memWrite(n,255&i),Tt(t.PS,i>255),_t(t.PS,255&i),Nt(t.PS,255&i),0},BCC:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(0===t.PS.C){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BCS:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(1===t.PS.C){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BEQ:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(1===t.PS.Z){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BIT:function(t,e,s){const{data:r}=s;return _t(t.PS,t.Register.A&r),t.PS.V=r>>6&1,Nt(t.PS,r),0},BMI:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(1===t.PS.N){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BNE:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(0===t.PS.Z){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BPL:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(0===t.PS.N){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BRK:function(t,e,s){return t.push16(t.Register.PC),t.push8(t.Register.PS),t.Register.PC=t.memRead(65534,2),Bt(t.PS,"BRK"),0},BVC:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(0===t.PS.V){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},BVS:function(t,e,s){const{data:r}=s,n=t.Register.PC;if(1===t.PS.V){const e=Dt(t.Register.PC+yt(r));return t.Register.PC=e,Lt(t.Register.PC,n)?2:1}return 0},CLC:function(t,e,s){return t.PS.C=0,0},CLD:function(t,e,s){return t.PS.D=0,0},CLI:function(t,e,s){return t.PS.I=0,0},CLV:function(t,e,s){return t.PS.V=0,0},CMP:function(t,e,s){const{data:r}=s,n=t.Register.A;return Tt(t.PS,n>=r),_t(t.PS,n-r),Nt(t.PS,n-r),"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},CPX:function(t,e,s){const{data:r}=s,n=t.Register.X;return Tt(t.PS,n>=r),_t(t.PS,n-r),Nt(t.PS,n-r),0},CPY:function(t,e,s){const{data:r}=s,n=t.Register.Y;return Tt(t.PS,n>=r),_t(t.PS,n-r),Nt(t.PS,n-r),0},DEC:function(t,e,s){const{addr:r,data:n}=s,i=n-1&255;return t.memWrite(r,i),_t(t.PS,i),Nt(t.PS,i),0},DEX:function(t,e,s){const r=t.Register.X-1&255;return t.Register.X=r,_t(t.PS,r),Nt(t.PS,r),0},DEY:function(t,e,s){const r=t.Register.Y-1&255;return t.Register.Y=r,_t(t.PS,r),Nt(t.PS,r),0},INC:function(t,e,s){const{addr:r,data:n}=s,i=n+1&255;return t.memWrite(r,i),_t(t.PS,i),Nt(t.PS,i),0},INX:function(t,e,s){const r=t.Register.X+1&255;return t.Register.X=r,_t(t.PS,r),Nt(t.PS,r),0},INY:function(t,e,s){const r=t.Register.Y+1&255;return t.Register.Y=r,_t(t.PS,r),Nt(t.PS,r),0},EOR:function(t,e,s){const{data:r}=s,n=t.Register.A^r;return t.Register.A=n,_t(t.PS,n),Nt(t.PS,n),"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},JMP:function(t,e,s){const{addr:r}=s;return t.Register.PC=r,0},JSR:function(t,e,s){const{addr:r}=s;return t.push16(t.Register.PC-1),t.Register.PC=r,0},RTS:function(t,e,s){return t.Register.PC=Dt(t.pull16()+1),0},LDA:function(t,e,s){const{data:r}=s;return t.Register.A=r,_t(t.PS,t.Register.A),Nt(t.PS,t.Register.A),"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},LDX:function(t,e,s){const{data:r}=s;return t.Register.X=r,_t(t.PS,t.Register.X),Nt(t.PS,t.Register.X),"AY"===e?s.isCrossPage:0},LDY:function(t,e,s){const{data:r}=s;return t.Register.Y=r,_t(t.PS,t.Register.Y),Nt(t.PS,t.Register.Y),"AX"===e?s.isCrossPage:0},LSR:function(t,e,s){const{addr:r,data:n}=s,i=n>>1;return"AC"===e?t.Register.A=i:t.memWrite(r,i),t.PS.C=1&n,_t(t.PS,i),Nt(t.PS,i),0},NOP:function(t,e,s){return 0},ORA:function(t,e,s){const{data:r}=s,n=t.Register.A|r;return t.Register.A=n,_t(t.PS,n),Nt(t.PS,n),"AX"===e||"AY"===e||"IY"===e?s.isCrossPage:0},PHA:function(t,e,s){return t.push8(t.Register.A),0},PHP:function(t,e,s){return t.push8(48|t.Register.PS),0},PLA:function(t,e,s){const r=t.pull8();return t.Register.A=r,_t(t.PS,r),Nt(t.PS,r),0},PLP:function(t,e,s){const r=t.pull8();return t.Register.PS=r,Bt(t.PS,"PLP"),0},ROL:function(t,e,s){const{addr:r,data:n}=s,i=n<<1|t.PS.C;return"AC"===e?t.Register.A=255&i:t.memWrite(r,255&i),Tt(t.PS,(128&n)>0),_t(t.PS,255&i),Nt(t.PS,255&i),0},ROR:function(t,e,s){const{addr:r,data:n}=s,i=n>>1|t.PS.C<<7;return"AC"===e?t.Register.A=255&i:t.memWrite(r,255&i),Tt(t.PS,(1&n)>0),_t(t.PS,255&i),Nt(t.PS,255&i),0},RTI:function(t,e,s){return t.Register.PS=t.pull8(),Bt(t.PS,"IRQ"),t.Register.PC=t.pull16(),0},SEC:function(t,e,s){return t.PS.C=1,0},SED:function(t,e,s){return t.PS.D=1,0},SEI:function(t,e,s){return t.PS.I=1,0},STA:function(t,e,s){const{addr:r}=s;return t.memWrite(r,t.Register.A),0},STX:function(t,e,s){const{addr:r}=s;return t.memWrite(r,t.Register.X),0},STY:function(t,e,s){const{addr:r}=s;return t.memWrite(r,t.Register.Y),0},TAX:function(t,e,s){const r=t.Register.A;return t.Register.X=r,_t(t.PS,r),Nt(t.PS,r),0},TAY:function(t,e,s){const r=t.Register.A;return t.Register.Y=r,_t(t.PS,r),Nt(t.PS,r),0},TSX:function(t,e,s){const r=t.Register.SP;return t.Register.X=r,_t(t.PS,r),Nt(t.PS,r),0},TXA:function(t,e,s){const r=t.Register.X;return t.Register.A=r,_t(t.PS,r),Nt(t.PS,r),0},TXS:function(t,e,s){return t.Register.SP=t.Register.X,0},TYA:function(t,e,s){const r=t.Register.Y;return t.Register.A=r,_t(t.PS,r),Nt(t.PS,r),0},AAC:function(t,e,s){return Zt.AND(t,e,s),t.Register.A>>7!=0&&Tt(t.PS,!0),0},AAX:function(t,e,s){const r=t.Register.X&t.Register.A;return t.memWrite(s.addr,r),0},ARR:function(t,e,s){Zt.AND(t,"I",s),Zt.ROR(t,"AC",{addr:-1,data:t.Register.A,isCrossPage:0});const r=t.Register.A>>4&1,n=t.Register.A>>5&1;return Tt(t.PS,1===n),t.PS.V=r^n,0},ASR:function(t,e,s){return Zt.AND(t,e,s),Zt.LSR(t,"AC",{addr:-1,data:t.Register.A,isCrossPage:0}),0},ATX:function(t,e,s){const r=t.Register.A&s.data;return t.Register.A=r,t.Register.X=r,_t(t.PS,r),Nt(t.PS,r),0},AXA:function(t,e,s){const r=t.Register.X&t.Register.A;return t.Register.A=r,t.memWrite(s.addr,7&r),0},AXS:function(t,e,s){return Zt.STX(t,e,s),Zt.PHA(t,e,s),Zt.AND(t,e,s),Zt.STA(t,e,s),Zt.PLA(t,e,s),0},DCP:function(t,e,s){return Zt.DEC(t,e,s),Zt.CMP(t,e,Object.assign(Object.assign({},s),{data:t.memRead(s.addr)})),0},DOP:function(t,e,s){return 0},ISC:function(t,e,s){return Zt.INC(t,e,s),Zt.SBC(t,e,Object.assign(Object.assign({},s),{data:t.memRead(s.addr)})),0},KIL:function(t,e,s){throw new Error("KIL(HLT) is executed. ")},LAX:function(t,e,s){const r=s.data;return t.Register.A=r,t.Register.X=r,_t(t.PS,r),Nt(t.PS,r),"AY"===e||"IY"===e?s.isCrossPage:0},RLA:function(t,e,s){return Zt.ROL(t,e,s),Zt.AND(t,e,Object.assign(Object.assign({},s),{data:t.memRead(s.addr)})),0},RRA:function(t,e,s){return Zt.ROR(t,e,s),Zt.ADC(t,e,Object.assign(Object.assign({},s),{data:t.memRead(s.addr)})),0},SLO:function(t,e,s){return Zt.ASL(t,e,s),Zt.ORA(t,e,Object.assign(Object.assign({},s),{data:t.memRead(s.addr)})),0},SRE:function(t,e,s){return Zt.LSR(t,e,s),Zt.EOR(t,e,Object.assign(Object.assign({},s),{data:t.memRead(s.addr)})),0},TOP:function(t,e,s){return"AX"===e?s.isCrossPage:0},XAA:function(t,e,s){return Zt.TXA(t,"IM",s),Zt.AND(t,e,s),0}},$t=function(t,e,s,r,n,i){return{name:t,opcode:e,bytes:s,cycles:r,mode:i,pageCycles:n}};var xt={105:$t("ADC",105,2,2,0,"I"),101:$t("ADC",101,2,3,0,"Z"),117:$t("ADC",117,2,4,0,"ZX"),109:$t("ADC",109,3,4,0,"A"),125:$t("ADC",125,3,4,1,"AX"),121:$t("ADC",121,3,4,1,"AY"),97:$t("ADC",97,2,6,0,"IX"),113:$t("ADC",113,2,5,1,"IY"),41:$t("AND",41,2,2,0,"I"),37:$t("AND",37,2,3,0,"Z"),53:$t("AND",53,2,4,0,"ZX"),45:$t("AND",45,3,4,0,"A"),61:$t("AND",61,3,4,1,"AX"),57:$t("AND",57,3,4,1,"AY"),33:$t("AND",33,2,6,0,"IX"),49:$t("AND",49,2,5,1,"IY"),10:$t("ASL",10,1,2,0,"AC"),6:$t("ASL",6,2,5,0,"Z"),22:$t("ASL",22,2,6,0,"ZX"),14:$t("ASL",14,3,6,0,"A"),30:$t("ASL",30,3,7,0,"AX"),144:$t("BCC",144,2,2,0,"R"),176:$t("BCS",176,2,2,0,"R"),240:$t("BEQ",240,2,2,0,"R"),36:$t("BIT",36,2,3,0,"Z"),44:$t("BIT",44,3,4,0,"A"),48:$t("BMI",48,2,2,0,"R"),208:$t("BNE",208,2,2,0,"R"),16:$t("BPL",16,2,2,0,"R"),0:$t("BRK",0,1,7,0,"IM"),80:$t("BVC",80,2,2,0,"R"),112:$t("BVS",112,2,2,0,"R"),24:$t("CLC",24,1,2,0,"IM"),216:$t("CLD",216,1,2,0,"IM"),88:$t("CLI",88,1,2,0,"IM"),184:$t("CLV",184,1,2,0,"IM"),201:$t("CMP",201,2,2,0,"I"),197:$t("CMP",197,2,3,0,"Z"),213:$t("CMP",213,2,4,0,"ZX"),205:$t("CMP",205,3,4,0,"A"),221:$t("CMP",221,3,4,1,"AX"),217:$t("CMP",217,3,4,1,"AY"),193:$t("CMP",193,2,6,0,"IX"),209:$t("CMP",209,2,5,1,"IY"),224:$t("CPX",224,2,2,0,"I"),228:$t("CPX",228,2,3,0,"Z"),236:$t("CPX",236,3,4,0,"A"),192:$t("CPY",192,2,2,0,"I"),196:$t("CPY",196,2,3,0,"Z"),204:$t("CPY",204,3,4,0,"A"),198:$t("DEC",198,2,5,0,"Z"),214:$t("DEC",214,2,6,0,"ZX"),206:$t("DEC",206,3,6,0,"A"),222:$t("DEC",222,3,7,0,"AX"),202:$t("DEX",202,1,2,0,"IM"),136:$t("DEY",136,1,2,0,"IM"),73:$t("EOR",73,2,2,0,"I"),69:$t("EOR",69,2,3,0,"Z"),85:$t("EOR",85,2,4,0,"ZX"),77:$t("EOR",77,3,4,0,"A"),93:$t("EOR",93,3,4,1,"AX"),89:$t("EOR",89,3,4,1,"AY"),65:$t("EOR",65,2,6,0,"IX"),81:$t("EOR",81,2,5,1,"IY"),230:$t("INC",230,2,5,0,"Z"),246:$t("INC",246,2,6,0,"ZX"),238:$t("INC",238,3,6,0,"A"),254:$t("INC",254,3,7,0,"AX"),232:$t("INX",232,1,2,0,"IM"),200:$t("INY",200,1,2,0,"IM"),76:$t("JMP",76,3,3,0,"A"),108:$t("JMP",108,3,5,0,"IN"),32:$t("JSR",32,3,6,0,"A"),169:$t("LDA",169,2,2,0,"I"),165:$t("LDA",165,2,3,0,"Z"),181:$t("LDA",181,2,4,0,"ZX"),173:$t("LDA",173,3,4,0,"A"),189:$t("LDA",189,3,4,1,"AX"),185:$t("LDA",185,3,4,1,"AY"),161:$t("LDA",161,2,6,0,"IX"),177:$t("LDA",177,2,5,1,"IY"),162:$t("LDX",162,2,2,0,"I"),166:$t("LDX",166,2,3,0,"Z"),182:$t("LDX",182,2,4,0,"ZY"),174:$t("LDX",174,3,4,0,"A"),190:$t("LDX",190,3,4,1,"AY"),160:$t("LDY",160,2,2,0,"I"),164:$t("LDY",164,2,3,0,"Z"),180:$t("LDY",180,2,4,0,"ZX"),172:$t("LDY",172,3,4,0,"A"),188:$t("LDY",188,3,4,1,"AX"),74:$t("LSR",74,1,2,0,"AC"),70:$t("LSR",70,2,5,0,"Z"),86:$t("LSR",86,2,6,0,"ZX"),78:$t("LSR",78,3,6,0,"A"),94:$t("LSR",94,3,7,0,"AX"),234:$t("NOP",234,1,2,0,"IM"),9:$t("ORA",9,2,2,0,"I"),5:$t("ORA",5,2,3,0,"Z"),21:$t("ORA",21,2,4,0,"ZX"),13:$t("ORA",13,3,4,0,"A"),29:$t("ORA",29,3,4,1,"AX"),25:$t("ORA",25,3,4,1,"AY"),1:$t("ORA",1,2,6,0,"IX"),17:$t("ORA",17,2,5,1,"IY"),72:$t("PHA",72,1,3,0,"IM"),8:$t("PHP",8,1,3,0,"IM"),104:$t("PLA",104,1,4,0,"IM"),40:$t("PLP",40,1,4,0,"IM"),42:$t("ROL",42,1,2,0,"AC"),38:$t("ROL",38,2,5,0,"Z"),54:$t("ROL",54,2,6,0,"ZX"),46:$t("ROL",46,3,6,0,"A"),62:$t("ROL",62,3,7,0,"AX"),106:$t("ROR",106,1,2,0,"AC"),102:$t("ROR",102,2,5,0,"Z"),118:$t("ROR",118,2,6,0,"ZX"),110:$t("ROR",110,3,6,0,"A"),126:$t("ROR",126,3,7,0,"AX"),64:$t("RTI",64,1,6,0,"IM"),96:$t("RTS",96,1,6,0,"IM"),233:$t("SBC",233,2,2,0,"I"),229:$t("SBC",229,2,3,0,"Z"),245:$t("SBC",245,2,4,0,"ZX"),237:$t("SBC",237,3,4,0,"A"),253:$t("SBC",253,3,4,1,"AX"),249:$t("SBC",249,3,4,1,"AY"),225:$t("SBC",225,2,6,0,"IX"),241:$t("SBC",241,2,5,1,"IY"),56:$t("SEC",56,1,2,0,"IM"),248:$t("SED",248,1,2,0,"IM"),120:$t("SEI",120,1,2,0,"IM"),133:$t("STA",133,2,3,0,"Z"),149:$t("STA",149,2,4,0,"ZX"),141:$t("STA",141,3,4,0,"A"),157:$t("STA",157,3,5,0,"AX"),153:$t("STA",153,3,5,0,"AY"),129:$t("STA",129,2,6,0,"IX"),145:$t("STA",145,2,6,0,"IY"),134:$t("STX",134,2,3,0,"Z"),150:$t("STX",150,2,4,0,"ZY"),142:$t("STX",142,3,4,0,"A"),132:$t("STY",132,2,3,0,"Z"),148:$t("STY",148,2,4,0,"ZX"),140:$t("STY",140,3,4,0,"A"),170:$t("TAX",170,1,2,0,"IM"),168:$t("TAY",168,1,2,0,"IM"),186:$t("TSX",186,1,2,0,"IM"),138:$t("TXA",138,1,2,0,"IM"),154:$t("TXS",154,1,2,0,"IM"),152:$t("TYA",152,1,2,0,"IM"),11:$t("AAC",11,2,2,0,"I"),43:$t("AAC",43,2,2,0,"I"),135:$t("AAX",135,2,3,0,"Z"),151:$t("AAX",151,2,4,0,"ZY"),131:$t("AAX",131,2,6,0,"IX"),143:$t("AAX",143,3,4,0,"A"),107:$t("ARR",107,2,2,0,"I"),75:$t("ASR",75,2,2,0,"I"),171:$t("ATX",171,2,2,0,"I"),159:$t("AXA",159,3,5,0,"AY"),147:$t("AXA",147,2,6,0,"IY"),203:$t("AXS",203,2,2,0,"I"),199:$t("DCP",199,2,5,0,"Z"),215:$t("DCP",215,2,6,0,"ZX"),207:$t("DCP",207,3,6,0,"A"),223:$t("DCP",223,3,7,0,"AX"),219:$t("DCP",219,3,7,0,"AY"),195:$t("DCP",195,2,8,0,"IX"),211:$t("DCP",211,2,8,0,"IY"),4:$t("DOP",4,2,3,0,"Z"),20:$t("DOP",20,2,4,0,"ZX"),52:$t("DOP",52,2,4,0,"ZX"),68:$t("DOP",68,2,3,0,"Z"),84:$t("DOP",84,2,4,0,"ZX"),100:$t("DOP",100,2,3,0,"Z"),116:$t("DOP",116,2,4,0,"ZX"),128:$t("DOP",128,2,2,0,"I"),130:$t("DOP",130,2,2,0,"I"),137:$t("DOP",137,2,2,0,"I"),194:$t("DOP",194,2,2,0,"I"),212:$t("DOP",212,2,4,0,"ZX"),226:$t("DOP",226,2,2,0,"I"),244:$t("DOP",244,2,4,0,"ZX"),231:$t("ISC",231,2,5,0,"Z"),247:$t("ISC",247,2,6,0,"ZX"),239:$t("ISC",239,3,6,0,"A"),255:$t("ISC",255,3,7,0,"AX"),251:$t("ISC",251,3,7,0,"AY"),227:$t("ISC",227,2,8,0,"IX"),243:$t("ISC",243,2,8,0,"IY"),2:$t("KIL",2,1,0,0,"IM"),18:$t("KIL",18,1,0,0,"IM"),34:$t("KIL",34,1,0,0,"IM"),50:$t("KIL",50,1,0,0,"IM"),66:$t("KIL",66,1,0,0,"IM"),82:$t("KIL",82,1,0,0,"IM"),98:$t("KIL",98,1,0,0,"IM"),114:$t("KIL",114,1,0,0,"IM"),146:$t("KIL",146,1,0,0,"IM"),178:$t("KIL",178,1,0,0,"IM"),210:$t("KIL",210,1,0,0,"IM"),242:$t("KIL",242,1,0,0,"IM"),187:$t("LAR",187,3,4,1,"AY"),167:$t("LAX",167,2,3,0,"Z"),183:$t("LAX",183,2,4,0,"ZY"),175:$t("LAX",175,3,4,0,"A"),191:$t("LAX",191,3,4,1,"AY"),163:$t("LAX",163,2,6,0,"IX"),179:$t("LAX",179,2,5,1,"IY"),26:$t("NOP",26,1,2,0,"IM"),58:$t("NOP",58,1,2,0,"IM"),90:$t("NOP",90,1,2,0,"IM"),122:$t("NOP",122,1,2,0,"IM"),218:$t("NOP",218,1,2,0,"IM"),250:$t("NOP",250,1,2,0,"IM"),39:$t("RLA",39,2,5,0,"Z"),55:$t("RLA",55,2,6,0,"ZX"),47:$t("RLA",47,3,6,0,"A"),63:$t("RLA",63,3,7,0,"AX"),59:$t("RLA",59,3,7,0,"AY"),35:$t("RLA",35,2,8,0,"IX"),51:$t("RLA",51,2,8,0,"IY"),103:$t("RRA",103,2,5,0,"Z"),119:$t("RRA",119,2,6,0,"ZX"),111:$t("RRA",111,3,6,0,"A"),127:$t("RRA",127,3,7,0,"AX"),123:$t("RRA",123,3,7,0,"AY"),99:$t("RRA",99,2,8,0,"IX"),115:$t("RRA",115,2,8,0,"IY"),235:$t("SBC",235,2,2,0,"I"),7:$t("SLO",7,2,5,0,"Z"),23:$t("SLO",23,2,6,0,"ZX"),15:$t("SLO",15,3,6,0,"A"),31:$t("SLO",31,3,7,0,"AX"),27:$t("SLO",27,3,7,0,"AY"),3:$t("SLO",3,2,8,0,"IX"),19:$t("SLO",19,2,8,0,"IY"),71:$t("SRE",71,2,5,0,"Z"),87:$t("SRE",87,2,6,0,"ZX"),79:$t("SRE",79,3,6,0,"A"),95:$t("SRE",95,3,7,0,"AX"),91:$t("SRE",91,3,7,0,"AY"),67:$t("SRE",67,2,8,0,"IX"),83:$t("SRE",83,2,8,0,"IY"),158:$t("SXA",158,3,5,0,"AY"),156:$t("SYA",156,3,5,0,"AX"),12:$t("TOP",12,3,4,0,"A"),28:$t("TOP",28,3,4,1,"AX"),60:$t("TOP",60,3,4,1,"AX"),92:$t("TOP",92,3,4,1,"AX"),124:$t("TOP",124,3,4,1,"AX"),220:$t("TOP",220,3,4,1,"AX"),252:$t("TOP",252,3,4,1,"AX"),139:$t("XAA",139,2,2,0,"IM"),155:$t("XAS",155,3,5,0,"AY")};const Ht=new class{constructor(){this.memory=Array(65536).fill(0),this._joypad=new St}memoryReset(){this.memory=Array(65536).fill(0)}get PRGROMLen(){return this._PRGROMLen}get rom(){return this._rom}get ppu(){return this._ppu}get cpu(){return this._cpu}get screen(){return this._screen}get joypad(){return this._joypad}connectCartridge(t){if(!this.cpu)throw new Error("there has no CPU.");this.memoryReset();const e=t.resolve();this._rom=e,this._PRGROMLen=e.PRGROM.length,this._ppu=new ut(this),this.cpu.IR_RESET()}connectScreen(t){this._screen=t}connectCPU(t){this._cpu=t}memWrite8(t,e){switch(t=wt(t)){case k:case E:case _:case Y:case B:case N:case Z:return void this.ppu.write[t](e);case $:return void this.ppu.write.OAM_DMA(e,this.readPage(e));case 16406:return void this.joypad.write(e)}t>=It&&t<=Mt?console.warn(`invalid write addr ${t} on PRG_ROM`):t>=vt&&t<=bt?console.warn(`address ${t.toString()} is read-only.`):this.memory[wt(t)]=e}memRead8(t){switch(t=wt(t),!0){case 16406===t:return this.joypad.read();case t===Z:case t===Y:case t===T:return this.ppu.read[t]();case t>=It&&t<=Mt:return this.readPRGROM(t-32768);case t>=vt&&t<=bt:return this.ppu.read[t]();default:return this.memory[t]}}memWrite16(t,e){t=wt(t),this.memory[t]=255&e,t<=Ot(t)&&(this.memory[t+1]=e>>8)}memRead16(t){return(t=wt(t))===L.IR.RESET?16384===this.rom.PRGROM.length?49152:32768:t+1<=Ot(t)?this.memRead8(t+1)<<8|this.memRead8(t):this.memRead8(function(t){switch(!0){case t<=255:return 0;case t<=mt:return Ct;case t<=bt:return vt;case t>=It:return It;default:return console.warn("不在范围内的地址"+t),32767}}(t))<<8|this.memRead8(t)}readPage(t){return!0==(t>=0&&t<=31)?this.memory.slice(t<<8,t+1<<8):(console.warn(`invalid read page addr ${t}`),[])}readPRGROM(t){return this.rom.PRGROM[t%this.rom.PRGROM.length]}},Vt=new class{constructor(t,e){var s;this._clockCycle=0,this.bus=e,this.bus.connectCPU(this),this.memoryMap=t,this.PS={C:0,Z:0,I:0,D:0,B:3,V:0,N:0},this.Register=(s=this.PS,{PC:0,SP:255,A:0,X:0,Y:0,get PS(){return 1&s.C|s.Z<<1&2|s.I<<2&4|s.D<<3&8|s.B<<4&48|s.V<<6&64|s.N<<7&128},set PS(t){s.C=1&t,s.Z=(2&t)>>1,s.I=(4&t)>>2,s.D=(8&t)>>3,s.B=(48&t)>>4,s.V=(64&t)>>6,s.N=(128&t)>>7}})}get clockCycle(){return this._clockCycle}step(){const{opcInfo:t,arg:e}=this.resolveAStatement(),s=Et[t.mode](this,e,t.name),r=t.cycles+Zt[t.name](this,t.mode,s);return this.takeCycles(r),{opcInfo:t,arg:e,addrRes:s}}resolveAStatement(){const t=this.readByteByPC(),e=xt[t];if(!e)throw new Error(`opcode ${t.toString(16)} is not exist. PC: ${(this.Register.PC-1).toString(16)}`);let s=0,r=0;for(;r<e.bytes-1;){s|=this.readByteByPC()<<8*r,r++}if(isNaN(s))throw new Error(`argument ${s} is not a number. opcode: ${t} addrmode: ${e.mode}`);return{opcInfo:e,arg:s}}readByteByPC(){return this.bus.memRead8(this.Register.PC++)}takeCycles(t=1){for(let e=0;e<t;e++)this._clockCycle++,this.bus.ppu.clockCycle+=3,"function"==typeof this.subClockCycleHandler&&this.subClockCycleHandler(this.clockCycle)}IR_RESET(){this.Register.A=0,this.Register.X=0,this.Register.Y=0,this.Register.PS=0,this.PS.I=1,this.PS.B=2,this.Register.SP=253,this.Register.PC=this.memRead(this.memoryMap.IR.RESET,2),this.takeCycles(7)}IR_NMI(){this.push16(this.Register.PC),Bt(this.PS,"NMI"),this.push8(this.Register.PS),Yt(this.PS,0),this.Register.PC=this.memRead(65530,2)}push8(t){if(this.Register.SP<0)throw new Error("Stack overflow");this.memWrite(this.Register.SP+256,t),this.Register.SP--}push16(t){const e=255&t,s=t>>8&255;this.push8(s),this.push8(e)}pull8(){if(255===this.Register.SP)throw new Error("Invalid pull");this.Register.SP++;return this.memRead(this.Register.SP+256)}pull16(){return this.pull8()|this.pull8()<<8}memWrite(t,e,s=1){if(1===s)this.bus.memWrite8(t,e);else{if(2!==s)throw new Error("value written in memory is too large.");this.bus.memWrite16(t,e)}}memRead(t,e=1){if(1===e)return this.bus.memRead8(t);if(2===e)return this.bus.memRead16(t);throw new Error("the number of byte should not large than 2.")}}(L,Ht),jt=function(t){let e,s;const r={},n=()=>{const{ADDR_SPACE:e}=t.memoryMap;return t.Register.PC===e.PRG_ROM_END||0===t.Register.PC||-1===t.memRead(t.Register.PC)||-1===t.Register.PC};return t.subClockCycleHandler=function(t){for(const e in r)t%parseInt(e)==0&&r[e].forEach((t=>t()))},{stop(){cancelAnimationFrame(s)},exec(e=1){for(let s=0;s<e;s++){const e=t.step();Xt.screen(`${kt(e.PC)} ${kt(e.opcInfo.opcode)} ${kt(e.arg)}   ${e.opcInfo.name} ${kt(-1===e.addrRes.addr?e.addrRes.data:e.addrRes.addr)}   A:${e.A} X:${e.X} Y:${e.Y} P:${e.P} SP:${e.SP} CYC:${e.CYC}`)}},launch(r){const n=178e4,i=Math.ceil(n/341/261*3),a=Math.floor(n/i/3),o=Math.floor(1e3/i);let c=window.performance.now();const u=()=>{const r=window.performance.now();if(r-c<o)s=requestAnimationFrame(u);else{c=r;for(let s=0;s<a;s++)try{t.step()}catch(t){throw clearInterval(e),t}s=requestAnimationFrame(u)}};s=requestAnimationFrame(u)},launchWithLog(){e=setInterval((()=>{for(let s=0;s<97;s++){if(n())return void clearInterval(e);try{const e=t.step();Xt.console(`${kt(e.PC)} ${("0"+kt(e.opcInfo.opcode)).slice(-2)} ${kt(e.arg)}   ${e.opcInfo.name} ${kt(-1===e.addrRes.addr?e.addrRes.data:e.addrRes.addr)}   A:${e.A} X:${e.X} Y:${e.Y} P:${e.P} SP:${e.SP} CYC:${e.CYC}`)}catch(t){throw clearInterval(e),t}}}),15)},registerRunningCallback(t,e){r[e]||(r[e]=[]),"function"==typeof t&&r[e].push(t)}}}(Vt);var Wt={bus:Ht,cpu:jt,joypad:Ht.joypad,Btn:Pt,Screen:class{constructor(t,e=1){this.scale=1,t.width=256*e,t.height=240*e,this.canvas=t,this.ctx=t.getContext("2d"),this.scale=e,this.ctx.clearRect(0,0,t.width,t.height),this.imageData=new ImageData(this.canvas.width,this.canvas.height),this.imageDataData=this.imageData.data}drawAPixel(t,e,s){const r=this.scale;!function(t,e,s,r,n,i,a){for(let o=n;o<n+a;o++)for(let n=r;n<r+i;n++){const r=o*t*4+4*n;0!==s[3]&&(e[r]=s[0],e[r+1]=s[1],e[r+2]=s[2],e[r+3]=255)}}(this.imageData.width,this.imageDataData,s,t*r,e*r,r,r)}drawBg(t){for(let e=0;e<t.length;e++){const s=e%32*8*this.scale,r=8*Math.floor(e/32)*this.scale;this.drawATile(t[e],s,r)}}drawATile(t,e,s){const r=this.scale,n=this.imageData.width;for(let i=0;i<8;i++)for(let a=0;a<8;a++){const o=s+i*r,c=e+(7-a)*r,u=this.imageData.data,l=t[i][a];for(let t=o;t<o+r;t++)for(let e=c;e<c+r;e++){const s=t*n*4+4*e;0!==l[3]&&(u[s]=l[0],u[s+1]=l[1],u[s+2]=l[2],u[s+3]=255)}}}render(){this.ctx.putImageData(this.imageData,0,0)}},Cartridge:class{constructor(t){this.binary=t}resolve(){const t=this.binary.slice(0,4),e=this.binary[4],s=this.binary[5],r=this.binary[6],n=this.binary[7];this.binary.slice(8,10);for(let e=0;e<t.length;e++)if(y[e]!==t[e])throw new Error("This file is not a .NES file.");const i=1&r,a=r>>2&1,o=r>>3&1,c=r>>4&15,u=n>>4&15;if(0!==(n>>2&3))throw new Error("Do not support others iNES format except iNES 1.0.");const l=16384*e,d=8192*s;let h=16;a&&(h+=512);const R=h+l;return console.log(`PRGROMSize:${l.toString(16)} CHRROMSize:${d.toString(16)}`),{PRGROM:this.binary.slice(h,h+l),CHRROM:this.binary.slice(R,R+d),mapper:c|u<<4,screenMirroring:o?D.FOUR_SCREEN:i?D.VERTICAL:D.HORIZONTAL}}}};function Ut(e){let s,n,i,R,A,f,g,p,P,S,C,m,I,M,v,b,w,O,X,y,D,L,k,E,T,_,Y,B,N,Z,$,x,H,V,j,W,U,G,K,F,J,q,z,Q,tt,et,st,rt,nt,it,at,ot,ct;return{c(){s=c("div"),n=c("h1"),n.textContent="Mengru's NES",i=u(),R=c("div"),R.innerHTML='<p class="title">Hello</p> \n    <div class="lists svelte-wtak8b"><ul class="nes-list is-disc"><li>Now this NES emulator only can run games without background scroll.</li> \n        <li>You can find source code in the <a href="https://github.com/mengrru/NES-Emulator">repo</a>.</li></ul></div>',A=u(),f=c("div"),g=c("select"),p=c("option"),p.textContent="No Cartridge Selected",P=c("option"),P.textContent="Pac-Man",S=u(),C=c("div"),m=c("canvas"),I=u(),M=c("div"),v=c("div"),b=c("div"),w=c("div"),w.innerHTML='<span class="nes-text is-primary svelte-wtak8b">W</span>',O=u(),X=c("div"),X.innerHTML='<span class="nes-text is-success svelte-wtak8b">S</span>',y=u(),D=c("div"),D.innerHTML='<span class="nes-text is-warning svelte-wtak8b">A</span>',L=u(),k=c("div"),k.innerHTML='<span class="nes-text is-error svelte-wtak8b">D</span>',E=u(),T=c("div"),_=u(),Y=c("div"),B=c("div"),N=c("p"),N.textContent="START",Z=u(),$=c("div"),$.innerHTML='<span class="nes-text is-disabled svelte-wtak8b">SPACE</span>',x=u(),H=c("div"),V=c("p"),V.textContent="SELECT",j=u(),W=c("div"),W.innerHTML='<span class="nes-text is-disabled svelte-wtak8b">ENTER</span>',U=u(),G=c("div"),K=c("div"),F=c("div"),F.innerHTML='<span class="is-error svelte-wtak8b">K</span>',J=u(),q=c("p"),q.textContent="B",z=u(),Q=c("div"),tt=c("div"),tt.innerHTML='<span class="is-error svelte-wtak8b">J</span>',et=u(),st=c("p"),st.textContent="A",rt=u(),nt=c("div"),nt.textContent="Nintendo®",it=u(),at=c("p"),d(n,"class","page-title svelte-wtak8b"),d(R,"class","nes-container with-title svelte-wtak8b"),p.__value="",p.value=p.__value,p.selected=!0,P.__value="./cartridges/pac-man.nes",P.value=P.__value,g.disabled=e[2],g.required=!0,d(g,"id","default_select"),d(f,"class","nes-select svelte-wtak8b"),d(m,"id","nes-canvas"),d(C,"class","nes-container is-rounded is-dark screen-container svelte-wtak8b"),d(w,"class","up svelte-wtak8b"),h(w,"pressed","Up"===e[1]),d(X,"class","down svelte-wtak8b"),h(X,"pressed","Down"===e[1]),d(D,"class","left svelte-wtak8b"),h(D,"pressed","Left"===e[1]),d(k,"class","right svelte-wtak8b"),h(k,"pressed","Right"===e[1]),d(T,"class","center svelte-wtak8b"),d(b,"class","joypad-direction-keys svelte-wtak8b"),d(N,"class","svelte-wtak8b"),d($,"class","btn svelte-wtak8b"),h($,"pressed","Start"===e[1]),d(B,"class","start svelte-wtak8b"),d(V,"class","svelte-wtak8b"),d(W,"class","btn svelte-wtak8b"),h(W,"pressed","Select"===e[1]),d(H,"class","select svelte-wtak8b"),d(Y,"class","joypad-function-keys svelte-wtak8b"),d(F,"class","btn nes-badge svelte-wtak8b"),h(F,"pressed","B"===e[1]),d(q,"class","svelte-wtak8b"),d(K,"class","b svelte-wtak8b"),d(tt,"class","btn nes-badge svelte-wtak8b"),h(tt,"pressed","A"===e[1]),d(st,"class","svelte-wtak8b"),d(Q,"class","a svelte-wtak8b"),d(G,"class","joypad-ab-keys svelte-wtak8b"),d(nt,"class","joypad-logo svelte-wtak8b"),d(v,"class","joypad-body svelte-wtak8b"),d(M,"class","joypad-container svelte-wtak8b"),d(s,"id","app"),d(s,"class","svelte-wtak8b")},m(t,r){!function(t,e,s){t.insertBefore(e,s||null)}(t,s,r),a(s,n),a(s,i),a(s,R),a(s,A),a(s,f),a(f,g),a(g,p),a(g,P),a(s,S),a(s,C),a(C,m),e[6](m),a(s,I),a(s,M),a(M,v),a(v,b),a(b,w),a(b,O),a(b,X),a(b,y),a(b,D),a(b,L),a(b,k),a(b,E),a(b,T),a(v,_),a(v,Y),a(Y,B),a(B,N),a(B,Z),a(B,$),a(Y,x),a(Y,H),a(H,V),a(H,j),a(H,W),a(v,U),a(v,G),a(G,K),a(K,F),a(K,J),a(K,q),a(G,z),a(G,Q),a(Q,tt),a(Q,et),a(Q,st),a(v,rt),a(v,nt),a(s,it),a(s,at),ot||(ct=[l(g,"change",e[5]),l(w,"touchstart",e[7],{passive:!0}),l(w,"mousedown",e[8]),l(w,"touchend",e[4],{passive:!0}),l(w,"mouseup",e[4]),l(X,"touchstart",e[9],{passive:!0}),l(X,"mousedown",e[10]),l(X,"touchend",e[4],{passive:!0}),l(X,"mouseup",e[4]),l(D,"touchstart",e[11],{passive:!0}),l(D,"mousedown",e[12]),l(D,"touchend",e[4],{passive:!0}),l(D,"mouseup",e[4]),l(k,"touchstart",e[13],{passive:!0}),l(k,"mousedown",e[14]),l(k,"touchend",e[4],{passive:!0}),l(k,"mouseup",e[4]),l($,"touchstart",e[15],{passive:!0}),l($,"mousedown",e[16]),l($,"touchend",e[4],{passive:!0}),l($,"mouseup",e[4]),l(W,"touchstart",e[17],{passive:!0}),l(W,"mousedown",e[18]),l(W,"touchend",e[4],{passive:!0}),l(W,"mouseup",e[4]),l(F,"touchstart",e[19],{passive:!0}),l(F,"mousedown",e[20]),l(F,"touchend",e[4],{passive:!0}),l(F,"mouseup",e[4]),l(tt,"touchstart",e[21],{passive:!0}),l(tt,"mousedown",e[22]),l(tt,"touchend",e[4],{passive:!0}),l(tt,"mouseup",e[4])],ot=!0)},p(t,[e]){4&e&&(g.disabled=t[2]),2&e&&h(w,"pressed","Up"===t[1]),2&e&&h(X,"pressed","Down"===t[1]),2&e&&h(D,"pressed","Left"===t[1]),2&e&&h(k,"pressed","Right"===t[1]),2&e&&h($,"pressed","Start"===t[1]),2&e&&h(W,"pressed","Select"===t[1]),2&e&&h(F,"pressed","B"===t[1]),2&e&&h(tt,"pressed","A"===t[1])},i:t,o:t,d(t){t&&o(s),e[6](null),ot=!1,r(ct)}}}function Gt(t,e,s){let r,n=null,i=!1;function a(t){Wt.joypad.setBtn(Wt.Btn[t]),s(1,n=t)}function o(){s(1,n=null)}document.onkeydown=t=>{switch(t.code.toLowerCase()){case"keya":a("Left");break;case"keyd":a("Right");break;case"keys":a("Down");break;case"keyw":a("Up");break;case"keyj":a("A");break;case"keyk":a("B");break;case"enter":a("Select");break;case"space":a("Start")}},document.onkeyup=()=>{o()};return[r,n,i,a,o,t=>{if(!t.target.value)return;s(2,i=!0);const e=Array.prototype.find.call(t.target,(t=>t.selected)),n=e.innerText;e.innerText+=" - loading",Wt.cpu.stop(),function(t,e){const s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",t,!0),s.onload=function(t){e(s.response)},s.send()}(t.target.value,(t=>{const a=new Wt.Cartridge(new Uint8Array(t));Wt.bus.connectScreen(new Wt.Screen(r,document.body.clientWidth<592?1:2)),Wt.bus.connectCartridge(a),Wt.cpu.launch(),e.innerText=n,s(2,i=!1)}))},function(t){g[t?"unshift":"push"]((()=>{r=t,s(0,r)}))},()=>a("Up"),()=>a("Up"),()=>a("Down"),()=>a("Down"),()=>a("Left"),()=>a("Left"),()=>a("Right"),()=>a("Right"),()=>a("Start"),()=>a("Start"),()=>a("Select"),()=>a("Select"),()=>a("B"),()=>a("B"),()=>a("A"),()=>a("A")]}return new class extends class{$destroy(){!function(t,e){const s=t.$$;null!==s.fragment&&(r(s.on_destroy),s.fragment&&s.fragment.d(e),s.on_destroy=s.fragment=null,s.ctx=[])}(this,1),this.$destroy=t}$on(t,e){const s=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return s.push(e),()=>{const t=s.indexOf(e);-1!==t&&s.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}{constructor(t){super(),X(this,t,Gt,Ut,i,{})}}({target:document.body})}();
//# sourceMappingURL=bundle.js.map
